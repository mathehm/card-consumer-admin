<div class="dashboard-container">
  <div class="dashboard-header">
    <h2>Dashboard</h2>
    <p>Resumo geral do sistema</p>
    
    <!-- Filtro de Data -->
    <div class="date-filter">
      <nz-form-item>
        <nz-form-label>Período do Relatório:</nz-form-label>
        <nz-form-control>
          <nz-range-picker 
            [(ngModel)]="dateRange" 
            nzFormat="dd/MM/yyyy"
            [nzPlaceHolder]="['Data inicial', 'Data final']"
            (ngModelChange)="onDateRangeChange()"
            style="width: 240px; margin-right: 8px;">
          </nz-range-picker>
          <button nz-button nzType="default" (click)="clearDateRange()">
            <span nz-icon nzType="close"></span>
            Limpar
          </button>
        </nz-form-control>
      </nz-form-item>
    </div>
  </div>

  <nz-spin [nzSpinning]="loading">
    <!-- Resumo Geral -->
    <div nz-row [nzGutter]="[16, 16]" class="summary-cards">
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            nzTitle="Produtos Ativos" 
            [nzValue]="summary.activeProducts"
            [nzValueStyle]="{ color: '#52c41a' }">
          </nz-statistic>
        </nz-card>
      </div>
      
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            nzTitle="Total de Produtos" 
            [nzValue]="summary.totalProducts"
            [nzValueStyle]="{ color: '#faad14' }">
          </nz-statistic>
        </nz-card>
      </div>
      
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            [nzTitle]="dateRange ? 'Itens Vendidos no Período' : 'Itens Vendidos Hoje'" 
            [nzValue]="summary.totalSalesToday"
            [nzValueStyle]="{ color: '#1890ff' }">
          </nz-statistic>
        </nz-card>
      </div>
      
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            [nzTitle]="dateRange ? 'Receita do Período' : 'Receita Hoje'" 
            [nzValue]="summary.totalRevenueToday"
            nzPrefix="R$"
            [nzValueStyle]="{ color: '#722ed1' }"
          >
          </nz-statistic>
        </nz-card>
      </div>
      
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            nzTitle="Crédito em Carteiras" 
            [nzValue]="summary.totalWalletCredit || 0"
            nzPrefix="R$"
            [nzValueStyle]="{ color: '#52c41a' }"
          >
          </nz-statistic>
        </nz-card>
      </div>
      
      <div nz-col nzXs="24" nzSm="12" nzMd="6" nzLg="6">
        <nz-card>
          <nz-statistic 
            nzTitle="Total de Vendas" 
            [nzValue]="summary.totalSales || 0"
            [nzValueStyle]="{ color: '#fa8c16' }"
          >
          </nz-statistic>
        </nz-card>
      </div>
    </div>


    <!-- Seção de Dados Detalhados -->
    <div nz-row [nzGutter]="[16, 16]" class="detail-section">
      <!-- Ranking de Produtos -->
      <div nz-col nzXs="24">
        <nz-card>
          <div slot="title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Ranking de Produtos</span>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button 
                nz-button 
                [nzType]="rankingType === 'quantity' ? 'primary' : 'default'" 
                nzSize="small"
                (click)="changeRankingType('quantity')">
                Por Quantidade
              </button>
              <button 
                nz-button 
                [nzType]="rankingType === 'revenue' ? 'primary' : 'default'" 
                nzSize="small"
                (click)="changeRankingType('revenue')">
                Por Receita
              </button>
              <nz-divider nzType="vertical"></nz-divider>
              <button 
                nz-button 
                nzType="default" 
                nzSize="small"
                (click)="exportToExcel()"
                title="Exportar para Excel">
                <span nz-icon nzType="download" nzTheme="outline"></span>
                Excel
              </button>
              <button 
                nz-button 
                nzType="default" 
                nzSize="small"
                (click)="exportToCSV()"
                title="Exportar para CSV">
                <span nz-icon nzType="download" nzTheme="outline"></span>
                CSV
              </button>
            </div>
          </div>
          <nz-table #productTable id="productTable" [nzData]="productStats" nzSize="middle" [nzShowPagination]="false" [nzPageSize]="1000" [nzScroll]="{ y: '400px' }">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Categoria</th>
                <th>Qtd. Vendida</th>
                <th>Receita</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stat of productTable.data; let i = index">
                <td>
                  <strong>{{ stat.productName }}</strong>
                  <br>
                  <small class="ranking-position">#{{ i + 1 }}</small>
                </td>
                <td>{{ stat.category || 'N/A' }}</td>
                <td>
                  <nz-statistic [nzValue]="stat.totalSold" [nzValueStyle]="{ fontSize: '14px' }">
                  </nz-statistic>
                </td>
                <td>
                  <nz-statistic 
                    [nzValue]="stat.totalRevenue" 
                    nzPrefix="R$"
                    [nzValueStyle]="{ fontSize: '14px', color: '#1890ff' }">
                  </nz-statistic>
                </td>
                <td>
                  <nz-tag [nzColor]="stat.isActive ? 'green' : 'red'" *ngIf="stat.isActive !== undefined">
                    {{ stat.isActive ? 'Ativo' : 'Inativo' }}
                  </nz-tag>
                  <span *ngIf="stat.isActive === undefined">N/A</span>
                </td>
              </tr>
            </tbody>
          </nz-table>
          
          <div *ngIf="productStats.length === 0" class="empty-message">
            <p>Nenhum produto foi vendido ainda</p>
          </div>
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>